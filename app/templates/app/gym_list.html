{%  extends 'app/base.html' %}
{%  block hero %}
    <section class="hero is-medium is-primary is-bold">
      <div class="hero-body">
        <div class="container">
          <h1 class="title">
            Gym Progress
          </h1>
          <h2 class="subtitle">
            Track your progress as you complete raids on each Gym in Leeds city center
          </h2>
          <progress class="progress is-large" value="{{ completed_gym_count }}" max="{{ total_gyms }}">{{ gym_progress }}%</progress>
            <h2 class="subtitle has-text-centered">{{ gym_progress }}% complete!</h2>
        </div>
      </div>
    </section>
{%  endblock %}
{%  block content %}
    <h1>Search</h1>
    <div class="dropdown" id="search-bar-container">
        <div class="field">
            <div class="control has-icons-right">
              <input class="input is-large" placeholder="Enter a gym name" id="gym-list-search-bar">
              <span class="icon is-medium is-right">
                <i class="fa fa-search"></i>
              </span>
            </div>
            <div class="dropdown-menu" id="dropdown-menu" role="menu"></div>
        </div>
    </div>
    {% if gyms_to_visit %}
        <h1>Gyms to visit</h1>
        <div id="gyms_to_visit">
            {%  for gym_item in gyms_to_visit %}
                {%  if forloop.counter0|divisibleby:3 %}
                    {%  if forloop.counter0 != 0 %}
                        </div>
                    {% endif %}
                    <div class="columns">
                {% endif %}
                <div class="column is-4">
                    <div class="card">
                      <div class="card-image">
                          <a href="/item/{{ gym_item.id }}/" class="card-image has-background-image" style="background-image: url('{{ gym_item.gym.image_url }}')">
                              <figure class="image is-4by3"></figure>
                              {%  with gym_item.get_raid_information as raid_info %}
                                {%  if raid_info %}
                                    <section class="raid-header hero is-small is-primary is-bold">
                                        <div class="hero-body">
                                            <div class="container">
                                             <h1 class="title">{{ raid_info.pokemon }} ({{ raid_info.level }})</h1>
                                             <h2 class="subtitle raid-counter">{{ raid_info.time_left }}</h2>
                                            </div>
                                        </div>
                                  </section>
                                {% endif %}
                            {% endwith %}
                          </a>
                      </div>
                      <div class="card-content">
                          <div class="media-content">
                            <p class="title is-4">{{ gym_item.gym.name }}</p>
                          </div>
                          <div class="content">
                            {% if gym_item.last_visit_date %}
                              <p>You last visited this gym on {{ gym_item.last_visit_date|date:"d/m/Y" }}</p>
                              {% else %}
                                  <p>You still need to visit this gym</p>
                              {% endif %}
                          </div>
                      </div>
                      <footer class="card-footer">
                        <a class="card-footer-item" href="/item/{{ gym_item.id }}/">Add Raid</a>
                        <!--<a class="card-footer-item" href="/hide/{{ gym_item.id }}/">Hide</a>-->
                      </footer>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% if completed_gym_list %}
        <h1>Visited Gyms</h1>
        <div id="completed_gyms">
        {%  for gym_item in completed_gym_list %}
            {%  if forloop.counter0|divisibleby:3 %}
                {%  if forloop.counter0 != 0 %}
                    </div>
                {% endif %}
                <div class="columns">
            {% endif %}
            <div class="column is-4">
                <div class="card">
                    <div class="card-image has-background-image" style="background-image: url('{{ gym_item.gym.image_url }}')">
                        <figure class="image is-4by3"></figure>
                    </div>
                  <div class="card-content">
                      <div class="media-content">
                        <p class="title is-4">{{ gym_item.gym.name }}</p>
                      </div>
                      <div class="content">
                        {% if gym_item.last_visit_date %}
                          <p>You last visited this gym on {{ gym_item.last_visit_date|date:"d/m/Y" }}</p>
                          {% else %}
                              <p>You still need to visit this gym</p>
                          {% endif %}
                      </div>
                  </div>
                  <footer class="card-footer">
                    <a class="card-footer-item" href="/item/{{ gym_item.id }}/">Add Raid</a>
                    <!--<a class="card-footer-item" href="/hide/{{ gym_item.id }}/">Hide</a>-->
                  </footer>
                </div>
            </div>
        {% endfor %}
        </div>
    {% endif %}
    <script type="text/javascript" src="https://cdn.rawgit.com/Gimpneek/JavaScript-autoComplete/1c337ba670508bbd70ad7fee18c691fbe26d8399/auto-complete.js"></script>
    <script>
    var choices = [
        {%  for gym_item in gyms_to_visit %}
            ['{{ gym_item.gym.name }}', '/item/{{ gym_item.id }}/'],
        {%  endfor %}
        {%  for gym_item in completed_gym_list %}
            ['{{ gym_item.gym.name }}', '/item/{{ gym_item.id }}/'],
        {%  endfor %}
    ];
    new autoComplete({
        selector: '#gym-list-search-bar',
        minChars: 1,
        menuClass: 'dropdown-content',
        source: function(term, suggest){
            term = term.toLowerCase();
            var suggestions = [];
            for (i=0;i<choices.length;i++) {
                if (~(choices[i][0] + ' ' + choices[i][1]).toLowerCase().indexOf(term)) suggestions.push(choices[i]);
            }
            suggest(suggestions);
        },
        renderItem: function (item, search){
            search = search.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            var re = new RegExp("(" + search.split(' ').join('|') + ")", "gi");
            return '<a class="dropdown-item autocomplete-suggestion" href="'+item[1]+'" data-val="'+search+'">'+item[0]+'</a>';
        },
        onSelect: function(e, term, item){
            window.location.href = item.getAttribute('href');
        }
    });
    </script>
    <script>
        setInterval(function(){
            var elements = document.getElementsByClassName("raid-counter");
            for(var i = 0; i < elements.length; i++){
                var element = elements[i];
                var current_time = element.textContent;
                var time_elements = current_time.split(':');
                current_time = new Date(0);
                current_time.setHours(parseInt(time_elements[0]));
                current_time.setMinutes(parseInt(time_elements[1]));
                current_time.setSeconds(parseInt(time_elements[2]));
                var time = current_time.getTime();
                time = time - 1000;
                var new_date = new Date(time);
                element.innerHTML = new_date.getHours() + ":"
                    + ("0" + new_date.getMinutes()).slice(-2) + ":"
                    + ("0" + new_date.getSeconds()).slice(-2)
                    + " remaining";
                if(time < 0){
                    element.parentNode.parentNode.parentNode.parentNode.removeChild(element.parentNode.parentNode.parentNode);
                }
            }
        }, 1000);
    </script>
{%  endblock %}
